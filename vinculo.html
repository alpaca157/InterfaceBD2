<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVITTA - V√≠nculos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>AVITTA</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="menu.html" class="nav-item">
                    <span class="nav-icon">üè†</span>
                    <span>Iniciar</span>
                </a>
                <a href="cadastro.html" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Cadastrar</span>
                </a>
                <a href="consultas.html" class="nav-item">
                    <span class="nav-icon">üìã</span>
                    <span>Registros</span>
                </a>
                <a href="vinculos.html" class="nav-item active">
                    <span class="nav-icon">üîó</span>
                    <span>V√≠nculos</span>
                </a>
                <a href="alertas.html" class="nav-item">
                    <span class="nav-icon">‚ö†Ô∏è</span>
                    <span>Alertas</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h1>Gerenciar V√≠nculos</h1>
            </header>

            <div class="content-wrapper">
                <div class="form-container">
                    <h3>Novo V√≠nculo Paciente-Profissional</h3>
                    <form onsubmit="criarVinculo(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Paciente</label>
                                <select id="select-paciente" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Profissional</label>
                                <select id="select-profissional" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data de In√≠cio</label>
                                <input type="date" id="data-inicio" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Criar V√≠nculo</button>
                    </form>
                </div>

                <div class="table-container">
                    <h3>V√≠nculos Ativos</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Profissional</th>
                                <th>Data In√≠cio</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-vinculos">
                            <tr><td colspan="4" style="text-align:center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarPacientes();
            carregarProfissionais();
            carregarVinculos();
        });

        async function carregarPacientes() {
            const response = await fetch(`${API_URL}/pacientes`);
            const pacientes = await response.json();
            
            const select = document.getElementById('select-paciente');
            pacientes.forEach(p => {
                const option = document.createElement('option');
                option.value = p.ID_Paciente;
                option.textContent = `${p.Nome} (CPF: ${p.CPF})`;
                select.appendChild(option);
            });
        }

        async function carregarProfissionais() {
            const response = await fetch(`${API_URL}/profissionais`);
            const profissionais = await response.json();
            
            const select = document.getElementById('select-profissional');
            profissionais.forEach(p => {
                const option = document.createElement('option');
                option.value = p.ID_Profissional_Saude;
                option.textContent = `Profissional ID: ${p.ID_Profissional_Saude}`;
                select.appendChild(option);
            });
        }

        async function criarVinculo(event) {
            event.preventDefault();
            
            const data = {
                id_paciente: parseInt(document.getElementById('select-paciente').value),
                id_profissional: parseInt(document.getElementById('select-profissional').value),
                data_inicio: document.getElementById('data-inicio').value
            };
            
            try {
                const response = await fetch(`${API_URL}/vinculos/profissional`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.sucesso) {
                    alert('‚úÖ V√≠nculo criado com sucesso!');
                    carregarVinculos();
                    event.target.reset();
                } else {
                    alert('‚ùå Erro: ' + result.erro);
                }
            } catch (error) {
                alert('‚ùå Erro de conex√£o');
            }
        }

        async function carregarVinculos() {
            // Implementar carga de v√≠nculos ativos
            // Usar consulta SQL apropriada
        }

        async function encerrarVinculo(idPaciente, idProfissional) {
            if (!confirm('Deseja encerrar este v√≠nculo?')) return;
            
            try {
                const response = await fetch(
                    `${API_URL}/vinculos/profissional/${idPaciente}/${idProfissional}`,
                    { method: 'PUT' }
                );
                
                const result = await response.json();
                
                if (result.sucesso) {
                    alert('‚úÖ V√≠nculo encerrado!');
                    carregarVinculos();
                } else {
                    alert('‚ùå Erro: ' + result.erro);
                }
            } catch (error) {
                alert('‚ùå Erro de conex√£o');
            }
        }
    </script>
</body>
</html>